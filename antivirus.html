<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scanner de Dossier Massif</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background-color: #111;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        .scanner-box {
            border: 2px solid #0f0;
            padding: 40px;
            width: 500px;
            text-align: center;
            background: #000;
            box-shadow: 0 0 15px #0f0;
            position: relative; 
        }
        
        /* MISE √Ä JOUR : PLUS DE D√âCORATIONS LAT√âRALES */
        .decoration {
            position: absolute;
            font-size: 20px;
            color: #f00; 
            z-index: 1;
            /* Animation simple pour un effet lumineux */
            animation: pulse 2s infinite alternate;
        }
        .decoration.top-left { top: 5px; left: 10px; }
        .decoration.top-right { top: 5px; right: 10px; }
        .decoration.mid-left { top: 40%; left: 10px; font-size: 16px; }
        .decoration.mid-right { top: 40%; right: 10px; font-size: 16px; }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        /* Boutons et Styles */
        .btn {
            background-color: #000;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: 0.2s;
            display: inline-block;
            text-decoration: none;
            line-height: 1.2;
        }
        .btn-scan { color: #0f0; border: 2px solid #0f0; }
        .btn-assistant { color: #00cccc; border: 2px solid #00cccc; } 
        .btn-modal-option { color: #000; background-color: #00cccc; border: 2px solid #00cccc; margin-top: 10px; display: block; width: 90%; margin-left: auto; margin-right: auto; }
        
        .btn:hover:not(:disabled) { background-color: #0f0; color: #000; border-color: #0f0; }
        .btn-assistant:hover:not(:disabled) { background-color: #00cccc; color: #000; border-color: #00cccc; }
        .btn-modal-option:hover { background-color: #00e5e5; }

        .btn:disabled { 
            border-color: #444; 
            color: #444; 
            cursor: not-allowed; 
            box-shadow: none; 
            background-color: #111;
        }
        
        /* Barres et Logs */
        #progress-container { 
            width: 100%; 
            background-color: #333; 
            height: 35px; /* AGRANDI */
            margin-top: 20px; 
            display: none; 
        }
        #progress-bar { 
            width: 0%; 
            height: 100%; 
            background-color: #0f0; 
            transition: width 0.1s; 
        }
        #log-area { margin-top: 20px; height: 150px; overflow-y: auto; text-align: left; border-top: 1px solid #333; font-size: 12px; color: #aaa; padding: 10px; }
        .virus-found { color: red; font-weight: bold; }
        .stats { margin-top: 10px; font-size: 14px; }
        #full-results-container { margin-top: 30px; max-height: 250px; overflow-y: auto; border: 1px dashed #333; padding: 10px; text-align: left; display: none; background: #000; }
        #full-results-container ul { list-style-type: none; padding: 0; margin: 0; }
        #full-results-container li { padding: 2px 0; border-bottom: 1px dotted #222; }

        /* Bandeau de Cookie */
        #cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #222; color: #fff; padding: 15px; text-align: center; z-index: 1000; display: none; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5); }
        #cookie-banner button { background-color: #0f0; color: #000; border: none; padding: 8px 15px; margin-left: 20px; cursor: pointer; font-weight: bold; }

        /* MODALE ASSISTANT */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .assistant-modal {
            background: #2d2d2d;
            border: 2px solid #00cccc;
            padding: 20px;
            width: 350px;
            text-align: left;
            border-radius: 8px;
            box-shadow: 0 0 25px rgba(0, 204, 204, 0.5);
            color: #00cccc;
        }
        .assistant-modal h3 { margin-top: 0; }
        .close-btn { 
            float: right; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: bold; 
            color: #ff0000;
            line-height: 1; 
        }
        /* Zone de chat simul√©e */
        #chat-content { 
            min-height: 100px; 
            background: #111; 
            border: 1px solid #444; 
            padding: 10px; 
            margin-bottom: 15px; 
            overflow-y: auto; 
            max-height: 250px;
        }
        .chat-message { margin-bottom: 10px; }
        .assistant-msg { color: #00cccc; }
        .user-options { margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<span class="decoration top-left">üéÑ</span>
<span class="decoration top-right">üéÅ</span>
<span class="decoration mid-left">‚≠ê</span>
<span class="decoration mid-right">üéÑ</span>


<div class="scanner-box">
    <h1>‚ò£Ô∏è SCANNER DE DOSSIER</h1>
    <p>S√©lectionnez un dossier pour lancer l'analyse automatique de tous ses fichiers.</p>

    <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
    
    <div style="margin-bottom: 15px;">
        <button class="btn btn-scan" id="mainScanButton" onclick="document.getElementById('folderInput').click()" disabled>
            LANCER LE SCAN DU DOSSIER
        </button>

        <button class="btn btn-assistant" id="openAssistantButton" onclick="openAssistantModal()" disabled>
            Contacter l'Assistant
        </button>
    </div>

    <button class="btn btn-scan" id="showAllFilesButton" style="display: none;" onclick="displayAllFiles()">
        Afficher tous les fichiers scann√©s (Clean + Infected)
    </button>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div class="stats" id="stats">En attente...</div>
    <div id="log-area"></div>
</div>

<div class="scanner-box" id="full-results-container">
    <h2>Liste Compl√®te des Fichiers</h2>
    <ul id="full-results-list"></ul>
</div>

<div id="cookie-banner">
    Ce site utilise le stockage local pour m√©moriser votre consentement et le statut de l'application. Aucune donn√©e personnelle n'est suivie.
    <button onclick="acceptCookies()">Accepter et continuer</button>
</div>

<div id="assistantModal" class="modal-overlay" onclick="closeAssistantModal(event)">
    <div class="assistant-modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeAssistantModal()">X</span>
        <h3>ü§ñ Assistant Virtuel</h3>

        <div id="chat-content">
            </div>
        
        <div class="user-options" id="user-options">
            </div>

        <button class="btn btn-scan" onclick="closeAssistantModal()">Fermer l'Assistant</button>
    </div>
</div>


<script>
    // --- NOUVELLE LOGIQUE D'ASSISTANT PAR BOUTONS ---

    const chatContent = document.getElementById('chat-content');
    const userOptionsDiv = document.getElementById('user-options');

    const ASSISTANT_FLOW = {
        'start': {
            message: "Bonjour ! Je suis l'assistant de votre scanner. Comment puis-je vous aider ?",
            options: [
                { text: "Probl√®me avec le site / le code", next: 'site_problem' },
                { text: "Le scanner ne d√©tecte rien", next: 'scanner_detect' },
                { text: "Faire une suggestion", next: 'suggestion' }
            ]
        },
        'site_problem': {
            message: "Avez-vous un probl√®me de chargement, de bouton ou d'affichage ?",
            options: [
                { text: "Probl√®me de bouton", next: 'button_issue' },
                { text: "Probl√®me d'affichage", next: 'display_issue' },
                { text: "Retour au menu principal", next: 'start' }
            ]
        },
        'button_issue': {
            message: "Si un bouton ne fonctionne pas, veuillez v√©rifier que vous avez bien accept√© les cookies. Si le probl√®me persiste, cela pourrait √™tre li√© √† votre navigateur. Souhaitez-vous contacter le d√©veloppeur ?",
            options: [
                { text: "Contacter le d√©veloppeur (simul√©)", next: 'contact_dev' },
                { text: "Retour au menu principal", next: 'start' }
            ]
        },
        'contact_dev': {
            message: "Merci ! Votre message a √©t√© enregistr√© (Ceci est une simulation pour l'instant). Nous reviendrons vers vous. Bonne journ√©e !",
            options: [
                { text: "Terminer", next: 'end' }
            ]
        },
        'scanner_detect': {
            message: "Le scanner utilise une base de donn√©es de hashs limit√©e pour des raisons de performance. Si vous pensez qu'un fichier est infect√©, veuillez le supprimer manuellement ou envoyer le hash (Ceci est une simulation).",
            options: [
                { text: "Retour au menu principal", next: 'start' }
            ]
        },
        'suggestion': {
            message: "Merci pour votre suggestion ! Nous notons que vous souhaitez plus de mises √† jour de No√´l et des am√©liorations visuelles (Ceci est une simulation).",
            options: [
                { text: "Terminer", next: 'end' }
            ]
        },
        'end': {
            message: "√Ä bient√¥t ! N'oubliez pas de partager notre scanner sur vos r√©seaux (TikTok, Reddit) !",
            options: []
        }
    };

    function displayMessage(message, className = 'assistant-msg') {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${className}`;
        msgDiv.textContent = message;
        chatContent.appendChild(msgDiv);
        // Scroll automatique vers le bas
        chatContent.scrollTop = chatContent.scrollHeight;
    }

    function displayOptions(options) {
        userOptionsDiv.innerHTML = ''; // Nettoie les anciens boutons
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'btn btn-modal-option';
            button.textContent = option.text;
            button.onclick = () => handleUserInput(option);
            userOptionsDiv.appendChild(button);
        });
    }

    function handleUserInput(option) {
        // Afficher la r√©ponse de l'utilisateur (le bouton qu'il a cliqu√©)
        displayMessage(`> ${option.text}`, 'user-msg'); 
        
        // Aller √† la prochaine √©tape de la conversation
        const nextStep = ASSISTANT_FLOW[option.next];
        if (nextStep) {
            setTimeout(() => {
                displayMessage(nextStep.message);
                displayOptions(nextStep.options);
                if (option.next === 'end') {
                    userOptionsDiv.innerHTML = ''; // Cache les boutons √† la fin
                }
            }, 500); // D√©lai pour simuler une "r√©flexion" de l'assistant
        }
    }

    function openAssistantModal() {
        document.getElementById('assistantModal').style.display = 'flex';
        chatContent.innerHTML = ''; // R√©initialise la conversation
        displayMessage(ASSISTANT_FLOW.start.message);
        displayOptions(ASSISTANT_FLOW.start.options);
    }

    function closeAssistantModal(event) {
        if (!event || event.target.id === 'assistantModal') {
            document.getElementById('assistantModal').style.display = 'none';
        }
    }


    // --- LOGIQUE DE CONSENTEMENT ET D'INITIALISATION (inchang√©e) ---
    
    function acceptCookies() {
        localStorage.setItem('cookieAccepted', 'true');
        document.getElementById('cookie-banner').style.display = 'none';
        document.getElementById('mainScanButton').disabled = false; 
        document.getElementById('openAssistantButton').disabled = false;
    }

    function checkCookieConsent() {
        const accepted = localStorage.getItem('cookieAccepted');
        const mainButton = document.getElementById('mainScanButton');
        const assistantButton = document.getElementById('openAssistantButton');
        const banner = document.getElementById('cookie-banner');

        if (accepted === 'true') {
            mainButton.disabled = false;
            assistantButton.disabled = false;
            banner.style.display = 'none';
        } else {
            mainButton.disabled = true;
            assistantButton.disabled = true;
            banner.style.display = 'flex';
        }
    }

    // --- Variables et initialisation (inchang√©e) ---
    let allScannedFiles = []; 
    // Hash d'un fichier vide pour l'exemple de virus
    const VIRUS_DB = ["e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];
    
    const folderInput = document.getElementById('folderInput');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const logArea = document.getElementById('log-area');
    const statsDiv = document.getElementById('stats');
    const showAllFilesButton = document.getElementById('showAllFilesButton');
    const fullResultsContainer = document.getElementById('full-results-container');
    const fullResultsList = document.getElementById('full-results-list');

    window.onload = checkCookieConsent;

    // --- Fonctions de scan et d'affichage (logique inchang√©e) ---
    function displayAllFiles() {
        fullResultsList.innerHTML = '';
        if (allScannedFiles.length === 0) {
            fullResultsList.innerHTML = '<li>Aucun fichier scann√© n\'est enregistr√©.</li>';
        } else {
            allScannedFiles.forEach(fileData => {
                const li = document.createElement('li');
                li.textContent = fileData.name;
                if (fileData.infected) {
                    li.className = 'virus-found';
                    li.textContent += ' [VIRUS]';
                }
                fullResultsList.appendChild(li);
            });
        }
        fullResultsContainer.style.display = 'block';
    }


    folderInput.addEventListener('change', async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;

        allScannedFiles = [];
        progressContainer.style.display = 'block';
        showAllFilesButton.style.display = 'none';
        fullResultsContainer.style.display = 'none';
        logArea.innerHTML = '';
        let infectedCount = 0;
        let processedCount = 0;
        progressBar.style.backgroundColor = "#0f0";
        
        logArea.innerHTML += `<div>üìÇ Dossier charg√©. ${files.length} fichiers √† scanner...</div>`;

        for (const file of files) {
            processedCount++;
            
            const percent = (processedCount / files.length) * 100;
            progressBar.style.width = percent + "%";
            statsDiv.textContent = `Analyse : ${processedCount} / ${files.length} fichiers. (D√©tect√©s: ${infectedCount})`;

            let isVirus = false;

            try {
                isVirus = await checkFile(file);
                
                allScannedFiles.push({
                    name: file.name,
                    infected: isVirus
                });

                if (isVirus) {
                    infectedCount++;
                    const logMsg = `<div class="virus-found">‚ö†Ô∏è VIRUS D√âTECT√â: ${file.name}</div>`;
                    logArea.innerHTML = logMsg + logArea.innerHTML;
                }
            } catch (err) {
                console.error("Erreur de lecture sur " + file.name, err);
            }
            
            if(processedCount % 10 === 0) await new Promise(r => setTimeout(r, 0));
        }

        statsDiv.textContent = `‚úÖ TERMIN√â. ${files.length} fichiers scann√©s. ${infectedCount} menaces trouv√©es.`;
        progressBar.style.backgroundColor = infectedCount > 0 ? "red" : "#0f0";
        
        showAllFilesButton.style.display = 'inline-block';
    });

    async function checkFile(file) {
        const arrayBuffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        return VIRUS_DB.includes(hashHex);
    }
</script>

</body>
</html>
