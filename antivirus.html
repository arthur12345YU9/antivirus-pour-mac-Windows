<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scanner de Dossier Massif</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background-color: #111;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        .scanner-box {
            border: 2px solid #0f0;
            padding: 40px;
            width: 500px;
            text-align: center;
            background: #000;
            box-shadow: 0 0 15px #0f0;
            position: relative; /* Pour les sapins */
        }
        
        /* NOUVEAU : D√âCORATION DE NO√ãL */
        .decoration {
            position: absolute;
            font-size: 20px;
            color: #f00; /* Rouge de No√´l */
            z-index: 1;
        }
        .decoration.left { top: 10px; left: 10px; }
        .decoration.right { top: 10px; right: 10px; }


        /* Boutons et Styles */
        .btn {
            background-color: #000;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: 0.2s;
            display: inline-block;
            text-decoration: none;
            line-height: 1.2;
        }
        .btn-scan { color: #0f0; border: 2px solid #0f0; }
        .btn-assistant { color: #00cccc; border: 2px solid #00cccc; } /* Style Cyan pour l'Assistant */
        .btn:hover:not(:disabled) { background-color: #0f0; color: #000; border-color: #0f0; }
        .btn-assistant:hover:not(:disabled) { background-color: #00cccc; color: #000; border-color: #00cccc; }

        .btn:disabled { 
            border-color: #444; 
            color: #444; 
            cursor: not-allowed; 
            box-shadow: none; 
            background-color: #111;
        }
        
        /* Barres et Logs */
        #progress-container { 
            width: 100%; 
            background-color: #333; 
            height: 35px; /* AGRANDI */
            margin-top: 20px; 
            display: none; 
        }
        #progress-bar { 
            width: 0%; 
            height: 100%; 
            background-color: #0f0; 
            transition: width 0.1s; 
        }
        #log-area { margin-top: 20px; height: 150px; overflow-y: auto; text-align: left; border-top: 1px solid #333; font-size: 12px; color: #aaa; padding: 10px; }
        .virus-found { color: red; font-weight: bold; }
        .stats { margin-top: 10px; font-size: 14px; }
        #full-results-container { margin-top: 30px; max-height: 250px; overflow-y: auto; border: 1px dashed #333; padding: 10px; text-align: left; display: none; background: #000; }
        #full-results-container ul { list-style-type: none; padding: 0; margin: 0; }
        #full-results-container li { padding: 2px 0; border-bottom: 1px dotted #222; }

        /* Bandeau de Cookie */
        #cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #222; color: #fff; padding: 15px; text-align: center; z-index: 1000; display: none; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5); }
        #cookie-banner button { background-color: #0f0; color: #000; border: none; padding: 8px 15px; margin-left: 20px; cursor: pointer; font-weight: bold; }

        /* --- NOUVEAU : MODALE ASSISTANT --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .assistant-modal {
            background: #2d2d2d;
            border: 2px solid #00cccc;
            padding: 20px;
            width: 350px;
            text-align: left;
            border-radius: 8px;
            box-shadow: 0 0 25px rgba(0, 204, 204, 0.5);
            color: #00cccc;
        }
        .assistant-modal h3 { margin-top: 0; }
        .close-btn { 
            float: right; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: bold; 
            color: #ff0000;
            line-height: 1; 
        }
    </style>
</head>
<body>

<span class="decoration left">üéÑ</span>
<span class="decoration right">üéÅ</span>

<div class="scanner-box">
    <h1>‚ò£Ô∏è SCANNER DE DOSSIER</h1>
    <p>S√©lectionnez un dossier pour lancer l'analyse automatique de tous ses fichiers.</p>

    <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
    
    <div style="margin-bottom: 15px;">
        <button class="btn btn-scan" id="mainScanButton" onclick="document.getElementById('folderInput').click()" disabled>
            LANCER LE SCAN DU DOSSIER
        </button>

        <button class="btn btn-assistant" id="openAssistantButton" onclick="openAssistantModal()" disabled>
            Contacter l'Assistant
        </button>
    </div>

    <button class="btn btn-scan" id="showAllFilesButton" style="display: none;" onclick="displayAllFiles()">
        Afficher tous les fichiers scann√©s (Clean + Infected)
    </button>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div class="stats" id="stats">En attente...</div>
    <div id="log-area"></div>
</div>

<div class="scanner-box" id="full-results-container">
    <h2>Liste Compl√®te des Fichiers</h2>
    <ul id="full-results-list"></ul>
</div>

<div id="cookie-banner">
    Ce site utilise le stockage local pour m√©moriser votre consentement et le statut de l'application. Aucune donn√©e personnelle n'est suivie.
    <button onclick="acceptCookies()">Accepter et continuer</button>
</div>

<div id="assistantModal" class="modal-overlay" onclick="closeAssistantModal(event)">
    <div class="assistant-modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeAssistantModal()">X</span>
        <h3>ü§ñ Assistant Virtuel</h3>
        <p>Bonjour ! Je suis l'assistant de votre scanner. Je suis l√† pour vous aider avec vos questions techniques, m√™me si je ne peux pas encore r√©pondre √† toutes les questions comme un humain.</p>
        <p><strong>Comment puis-je vous aider aujourd'hui ?</strong></p>
        <button class="btn btn-scan" onclick="closeAssistantModal()">Fermer</button>
    </div>
</div>


<script>
    // --- NOUVELLE LOGIQUE DE MODALE ASSISTANT ---
    function openAssistantModal() {
        document.getElementById('assistantModal').style.display = 'flex';
    }

    function closeAssistantModal(event) {
        // Ferme si l'utilisateur clique sur le X ou sur le bouton Fermer
        if (event && event.target.id === 'assistantModal') {
            document.getElementById('assistantModal').style.display = 'none';
        } else if (!event) {
            document.getElementById('assistantModal').style.display = 'none';
        }
    }


    // --- LOGIQUE DE CONSENTEMENT ET D'INITIALISATION ---
    
    function acceptCookies() {
        localStorage.setItem('cookieAccepted', 'true');
        document.getElementById('cookie-banner').style.display = 'none';
        document.getElementById('mainScanButton').disabled = false; 
        document.getElementById('openAssistantButton').disabled = false;
    }

    function checkCookieConsent() {
        const accepted = localStorage.getItem('cookieAccepted');
        const mainButton = document.getElementById('mainScanButton');
        const assistantButton = document.getElementById('openAssistantButton');
        const banner = document.getElementById('cookie-banner');

        if (accepted === 'true') {
            mainButton.disabled = false;
            assistantButton.disabled = false;
            banner.style.display = 'none';
        } else {
            mainButton.disabled = true;
            assistantButton.disabled = true;
            banner.style.display = 'flex';
        }
    }

    // --- Variables et initialisation ---
    let allScannedFiles = []; 
    // Hash d'un fichier vide pour l'exemple de virus
    const VIRUS_DB = ["e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];
    
    const folderInput = document.getElementById('folderInput');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const logArea = document.getElementById('log-area');
    const statsDiv = document.getElementById('stats');
    const showAllFilesButton = document.getElementById('showAllFilesButton');
    const fullResultsContainer = document.getElementById('full-results-container');
    const fullResultsList = document.getElementById('full-results-list');

    window.onload = checkCookieConsent;

    // --- Fonctions de scan et d'affichage (logique inchang√©e) ---
    function displayAllFiles() {
        fullResultsList.innerHTML = '';
        if (allScannedFiles.length === 0) {
            fullResultsList.innerHTML = '<li>Aucun fichier scann√© n\'est enregistr√©.</li>';
        } else {
            allScannedFiles.forEach(fileData => {
                const li = document.createElement('li');
                li.textContent = fileData.name;
                if (fileData.infected) {
                    li.className = 'virus-found';
                    li.textContent += ' [VIRUS]';
                }
                fullResultsList.appendChild(li);
            });
        }
        fullResultsContainer.style.display = 'block';
    }


    folderInput.addEventListener('change', async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;

        allScannedFiles = [];
        progressContainer.style.display = 'block';
        showAllFilesButton.style.display = 'none';
        fullResultsContainer.style.display = 'none';
        logArea.innerHTML = '';
        let infectedCount = 0;
        let processedCount = 0;
        progressBar.style.backgroundColor = "#0f0";
        
        logArea.innerHTML += `<div>üìÇ Dossier charg√©. ${files.length} fichiers √† scanner...</div>`;

        for (const file of files) {
            processedCount++;
            
            const percent = (processedCount / files.length) * 100;
            progressBar.style.width = percent + "%";
            statsDiv.textContent = `Analyse : ${processedCount} / ${files.length} fichiers. (D√©tect√©s: ${infectedCount})`;

            let isVirus = false;

            try {
                isVirus = await checkFile(file);
                
                allScannedFiles.push({
                    name: file.name,
                    infected: isVirus
                });

                if (isVirus) {
                    infectedCount++;
                    const logMsg = `<div class="virus-found">‚ö†Ô∏è VIRUS D√âTECT√â: ${file.name}</div>`;
                    logArea.innerHTML = logMsg + logArea.innerHTML;
                }
            } catch (err) {
                console.error("Erreur de lecture sur " + file.name, err);
            }
            
            if(processedCount % 10 === 0) await new Promise(r => setTimeout(r, 0));
        }

        statsDiv.textContent = `‚úÖ TERMIN√â. ${files.length} fichiers scann√©s. ${infectedCount} menaces trouv√©es.`;
        progressBar.style.backgroundColor = infectedCount > 0 ? "red" : "#0f0";
        
        showAllFilesButton.style.display = 'inline-block';
    });

    async function checkFile(file) {
        const arrayBuffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        return VIRUS_DB.includes(hashHex);
    }
</script>

</body>
</html>